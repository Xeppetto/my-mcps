#!/usr/bin/env node

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';
import axios from 'axios';
// .env íŒŒì¼ ëŒ€ì‹  í™˜ê²½ë³€ìˆ˜ì—ì„œ ì§ì ‘ ì½ìŒ

// MCP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const server = new Server(
  {
    name: 'jira-mcp-server',
    version: '0.1.0',
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

// ë„êµ¬ ëª©ë¡ ì •ì˜
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [
      {
        name: 'get_user_issues',
        description: 'íŠ¹ì • ì‚¬ìš©ìê°€ ìƒì„±í•œ ì´ìŠˆ ì¡°íšŒ',
        inputSchema: {
          type: 'object',
          properties: {
            username: {
              type: 'string',
              description: 'Jira ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼',
            },
            days: {
              type: 'number',
              description: 'ì¡°íšŒí•  ì¼ìˆ˜ (ê¸°ë³¸ê°’: 7ì¼)',
              default: 7,
            },
          },
          required: ['username'],
        },
      },
      {
        name: 'get_user_comments',
        description: 'íŠ¹ì • ì‚¬ìš©ìê°€ ëŒ“ê¸€ì„ ë‹¨ ì´ìŠˆë“¤ ì¡°íšŒ',
        inputSchema: {
          type: 'object',
          properties: {
            username: {
              type: 'string',
              description: 'Jira ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼',
            },
            days: {
              type: 'number',
              description: 'ì¡°íšŒí•  ì¼ìˆ˜ (ê¸°ë³¸ê°’: 7ì¼)',
              default: 7,
            },
          },
          required: ['username'],
        },
      },
      {
        name: 'get_issue_comments',
        description: 'íŠ¹ì • ì´ìŠˆì˜ ëŒ“ê¸€ ìƒì„¸ ì¡°íšŒ',
        inputSchema: {
          type: 'object',
          properties: {
            issueKey: {
              type: 'string',
              description: 'ì´ìŠˆ í‚¤ (ì˜ˆ: EZQA-1258)',
            },
            username: {
              type: 'string',
              description: 'íŠ¹ì • ì‚¬ìš©ìì˜ ëŒ“ê¸€ë§Œ í•„í„°ë§ (ì„ íƒì‚¬í•­)',
            },
          },
          required: ['issueKey'],
        },
      },
    ],
  };
});

// ë„êµ¬ ì‹¤í–‰ í•¸ë“¤ëŸ¬
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params;

  try {
    switch (name) {
      case 'get_user_issues':
        return await getUserIssues(args.username, args.days || 7);
      
      case 'get_user_comments':
        return await getUserComments(args.username, args.days || 7);
      
      case 'get_issue_comments':
        return await getIssueComments(args.issueKey, args.username);
      
      
      default:
        throw new Error(`Unknown tool: ${name}`);
    }
  } catch (error) {
    return {
      content: [
        {
          type: 'text',
          text: `Error: ${error.message}`,
        },
      ],
    };
  }
});

// Jira API ì„¤ì •
const JIRA_BASE_URL = process.env.JIRA_URL;
const JIRA_EMAIL = process.env.JIRA_EMAIL;
const JIRA_API_TOKEN = process.env.JIRA_API_TOKEN;

// Jira API í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
const jiraClient = axios.create({
  baseURL: JIRA_BASE_URL,
  auth: {
    username: JIRA_EMAIL,
    password: JIRA_API_TOKEN,
  },
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
  },
});

// ì‚¬ìš©ìê°€ ìƒì„±í•œ ì´ìŠˆ ì¡°íšŒ í•¨ìˆ˜
async function getUserIssues(username, days) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  const dateStr = startDate.toISOString().split('T')[0];

  try {
    const response = await jiraClient.get('/rest/api/3/search', {
      params: {
        jql: `reporter = "${username}" AND created >= "${dateStr}"`,
        fields: 'key,summary,status,created,priority,issuetype',
        maxResults: 100,
      },
    });

    const issues = response.data.issues.map(issue => ({
      key: issue.key,
      summary: issue.fields.summary,
      status: issue.fields.status.name,
      created: issue.fields.created,
      priority: issue.fields.priority?.name || 'None',
      issueType: issue.fields.issuetype.name,
    }));

    return {
      content: [
        {
          type: 'text',
          text: `${username}ë‹˜ì´ ìµœê·¼ ${days}ì¼ ë™ì•ˆ ìƒì„±í•œ ì´ìŠˆ (ì´ ${issues.length}ê°œ):\n\n` +
                issues.map(issue => 
                  `â€¢ [${issue.key}] ${issue.summary}\n` +
                  `  ìƒíƒœ: ${issue.status} | ìš°ì„ ìˆœìœ„: ${issue.priority} | ìœ í˜•: ${issue.issueType}\n` +
                  `  ìƒì„±ì¼: ${new Date(issue.created).toLocaleString('ko-KR')}\n`
                ).join('\n'),
        },
      ],
    };
  } catch (error) {
    throw new Error(`Jira API í˜¸ì¶œ ì‹¤íŒ¨: ${error.response?.data?.errorMessages || error.message}`);
  }
}

// ì‚¬ìš©ìê°€ ëŒ“ê¸€ì„ ë‹¨ ì´ìŠˆ ì¡°íšŒ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
async function getUserComments(username, days) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  const dateStr = startDate.toISOString().split('T')[0];

  try {
    // ë°©ë²• 1: ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ì´ìŠˆë“¤ì„ ê°€ì ¸ì™€ì„œ ëŒ“ê¸€ í•„í„°ë§
    console.error(`ëŒ“ê¸€ ì¡°íšŒ ì‹œë„: ${username}, ${days}ì¼`);
    
    let commentDetails = [];
    let searchApproach = 'updated-issues';
    
    try {
      // ë¨¼ì € commentedBy í•„ë“œë¥¼ ì‚¬ìš©í•´ë³´ê¸°
      const response = await jiraClient.get('/rest/api/3/search', {
        params: {
          jql: `commentedBy = "${username}" AND updated >= "${dateStr}"`,
          fields: 'key,summary,status,updated',
          maxResults: 50,
        },
      });
      
      console.error(`commentedBy í•„ë“œ ì‚¬ìš© ì„±ê³µ: ${response.data.issues.length}ê°œ ì´ìŠˆ`);
      commentDetails = await processIssuesForComments(response.data.issues, username, startDate);
      
    } catch (commentedByError) {
      console.error(`commentedBy í•„ë“œ ì‚¬ìš© ì‹¤íŒ¨: ${commentedByError.message}`);
      
      // ëŒ€ì•ˆ ë°©ë²•: ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ëª¨ë“  ì´ìŠˆë¥¼ ê°€ì ¸ì™€ì„œ ìˆ˜ë™ìœ¼ë¡œ ëŒ“ê¸€ í™•ì¸
      searchApproach = 'manual-filter';
      const response = await jiraClient.get('/rest/api/3/search', {
        params: {
          jql: `updated >= "${dateStr}" ORDER BY updated DESC`,
          fields: 'key,summary,status,updated',
          maxResults: 100,
        },
      });
      
      console.error(`ëŒ€ì•ˆ ë°©ë²• ì‚¬ìš©: ${response.data.issues.length}ê°œ ì´ìŠˆ ê²€í† `);
      commentDetails = await processIssuesForComments(response.data.issues, username, startDate);
    }

    const totalComments = commentDetails.reduce((sum, issue) => sum + issue.comments.length, 0);

    return {
      content: [
        {
          type: 'text',
          text: `${username}ë‹˜ì˜ ìµœê·¼ ${days}ì¼ ëŒ“ê¸€ í™œë™ (${searchApproach === 'updated-issues' ? 'commentedBy í•„ë“œ ì‚¬ìš©' : 'ìˆ˜ë™ í•„í„°ë§'}):\n\n` +
                `ğŸ“Š **ìš”ì•½**: ${commentDetails.length}ê°œ ì´ìŠˆ, ${totalComments}ê°œ ëŒ“ê¸€\n\n` +
                (commentDetails.length > 0 ? 
                  commentDetails.map(issue => 
                    `ğŸ« **[${issue.issueKey}]** ${issue.issueSummary}\n` +
                    `   ğŸ“‹ ìƒíƒœ: ${issue.issueStatus}\n` +
                    issue.comments.map(comment => 
                      `   ğŸ’¬ ${new Date(comment.created).toLocaleString('ko-KR')}\n` +
                      `      "${comment.body.substring(0, 200)}${comment.body.length > 200 ? '...' : ''}"\n`
                    ).join('') + '\n'
                  ).join('') :
                  'ì´ ê¸°ê°„ ë™ì•ˆ ëŒ“ê¸€ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.\n'
                ),
        },
      ],
    };
  } catch (error) {
    // ê¶Œí•œ ë¶€ì¡± ì‹œ ëŒ€ì•ˆ ë©”ì‹œì§€ ì œê³µ
    if (error.response?.status === 400 || error.response?.status === 403) {
      return {
        content: [
          {
            type: 'text',
            text: `âŒ ëŒ“ê¸€ ì¡°íšŒ ê¶Œí•œ ë¶€ì¡±\n\n` +
                  `**ë¬¸ì œ**: ${error.response?.data?.errorMessages?.[0] || error.message}\n\n` +
                  `**í•´ê²° ë°©ë²•**:\n` +
                  `1. ğŸ”‘ Jira ê´€ë¦¬ìì—ê²Œ ëŒ“ê¸€ ì¡°íšŒ ê¶Œí•œ ìš”ì²­\n` +
                  `2. ğŸ‘¥ í”„ë¡œì íŠ¸ ë©¤ë²„ì‹­ í™•ì¸\n` +
                  `3. ğŸ› ï¸ API í† í° ê¶Œí•œ ë²”ìœ„ í™•ì¸\n` +
                  `4. ğŸ“‹ í”„ë¡œì íŠ¸ë³„ ê¶Œí•œ ì„¤ì • ì ê²€\n\n` +
                  `**ëŒ€ì•ˆ**: ê°œë³„ ì´ìŠˆ ìƒì„¸ ì¡°íšŒë¥¼ í†µí•´ ëŒ“ê¸€ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.`,
          },
        ],
      };
    }
    throw new Error(`Jira API í˜¸ì¶œ ì‹¤íŒ¨: ${error.response?.data?.errorMessages || error.message}`);
  }
}

// ì´ìŠˆë“¤ì—ì„œ íŠ¹ì • ì‚¬ìš©ìì˜ ëŒ“ê¸€ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
async function processIssuesForComments(issues, username, startDate) {
  const commentDetails = [];
  
  for (const issue of issues.slice(0, 20)) { // ì„±ëŠ¥ì„ ìœ„í•´ ìµœëŒ€ 20ê°œ ì´ìŠˆë§Œ ì²˜ë¦¬
    try {
      const commentsResponse = await jiraClient.get(`/rest/api/3/issue/${issue.key}/comment`, {
        params: {
          orderBy: '-created', // ìµœì‹  ëŒ“ê¸€ë¶€í„°
          maxResults: 50,
        },
      });
      
      const userComments = commentsResponse.data.comments.filter(comment => {
        const commentDate = new Date(comment.created);
        const commentAuthor = comment.author?.emailAddress || comment.author?.displayName || '';
        
        return commentDate >= startDate && 
               (commentAuthor === username || 
                commentAuthor.toLowerCase().includes(username.toLowerCase()) ||
                comment.author?.displayName === username);
      });

      if (userComments.length > 0) {
        commentDetails.push({
          issueKey: issue.key,
          issueSummary: issue.fields.summary,
          issueStatus: issue.fields.status.name,
          comments: userComments.map(comment => ({
            body: extractCommentText(comment.body),
            created: comment.created,
            author: comment.author?.displayName || 'Unknown',
          })),
        });
      }
    } catch (commentError) {
      console.error(`ì´ìŠˆ ${issue.key} ëŒ“ê¸€ ì¡°íšŒ ì‹¤íŒ¨:`, commentError.message);
      continue; // ê°œë³„ ì´ìŠˆ ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
    }
  }
  
  return commentDetails;
}

// ëŒ“ê¸€ ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ í•¨ìˆ˜
function extractCommentText(commentBody) {
  if (typeof commentBody === 'string') {
    return commentBody;
  }
  
  if (commentBody?.content) {
    // ADF (Atlassian Document Format) ì²˜ë¦¬
    return extractTextFromADF(commentBody.content);
  }
  
  return JSON.stringify(commentBody);
}

// ADFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
function extractTextFromADF(content) {
  let text = '';
  
  if (Array.isArray(content)) {
    content.forEach(node => {
      if (node.type === 'paragraph' && node.content) {
        node.content.forEach(textNode => {
          if (textNode.type === 'text' && textNode.text) {
            text += textNode.text + ' ';
          }
        });
      } else if (node.type === 'text' && node.text) {
        text += node.text + ' ';
      }
    });
  }
  
  return text.trim() || '(í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨)';
}

// íŠ¹ì • ì´ìŠˆì˜ ëŒ“ê¸€ ìƒì„¸ ì¡°íšŒ í•¨ìˆ˜
async function getIssueComments(issueKey, username) {
  try {
    const commentsResponse = await jiraClient.get(`/rest/api/3/issue/${issueKey}/comment`, {
      params: {
        orderBy: '-created',
        maxResults: 100,
      },
    });

    let comments = commentsResponse.data.comments;
    
    // íŠ¹ì • ì‚¬ìš©ì í•„í„°ë§
    if (username) {
      comments = comments.filter(comment => {
        const author = comment.author?.emailAddress || comment.author?.displayName || '';
        return author === username || 
               author.toLowerCase().includes(username.toLowerCase()) ||
               comment.author?.displayName === username;
      });
    }

    const commentDetails = comments.map(comment => ({
      id: comment.id,
      author: comment.author?.displayName || 'Unknown',
      authorEmail: comment.author?.emailAddress || '',
      created: comment.created,
      updated: comment.updated,
      body: extractCommentText(comment.body),
    }));

    return {
      content: [
        {
          type: 'text',
          text: `ğŸ« **ì´ìŠˆ ${issueKey} ëŒ“ê¸€ ì¡°íšŒ** ${username ? `(${username} ì‚¬ìš©ìë§Œ)` : ''}\n\n` +
                `ğŸ“Š **ì´ ${commentDetails.length}ê°œ ëŒ“ê¸€**\n\n` +
                (commentDetails.length > 0 ?
                  commentDetails.map((comment, index) =>
                    `**${index + 1}. ${comment.author}** (${comment.authorEmail})\n` +
                    `ğŸ“… ì‘ì„±: ${new Date(comment.created).toLocaleString('ko-KR')}\n` +
                    `${comment.updated !== comment.created ? `ğŸ“ ìˆ˜ì •: ${new Date(comment.updated).toLocaleString('ko-KR')}\n` : ''}` +
                    `ğŸ’¬ ë‚´ìš©: ${comment.body}\n\n`
                  ).join('') :
                  'ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.\n'
                ),
        },
      ],
    };
  } catch (error) {
    throw new Error(`ì´ìŠˆ ëŒ“ê¸€ ì¡°íšŒ ì‹¤íŒ¨: ${error.response?.data?.errorMessages || error.message}`);
  }
}

// ì„œë²„ ì‹œì‘
async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error('Jira MCP Server running on stdio');
}

main().catch(console.error);